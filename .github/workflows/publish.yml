name: CD Update version and publish to stores
on:
  workflow_dispatch:
    inputs:
      newAddonVersion:
        description: 'Please input version number in this format(YY.MM.DD.XX): 21.12.31.01'
        required: true

jobs:
  CD:
    runs-on: ubuntu-latest
    steps:
      - name: Show who executed this
        run: echo "${{ github.event.sender.login }}"
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: Update version
        run: |
          cd ${{ github.workspace }}/src/
          echo "New Version: ${{ github.event.inputs.newAddonVersion }}"
          sed -i'' -e 's|"version":.*|"version": "${{ github.event.inputs.newAddonVersion }}",|' manifest.json
          cat manifest.json

      - name: Commit new version
        run: |
          git config --global user.name 'CD Publish Job'
          git config --global user.email 'MHCT_PUBLISH_WORKFLOW@users.noreply.github.com'
          git add src/manifest.json
          git commit -m "Automated version update"
          git push
          git tag "v${{ github.event.inputs.newAddonVersion }}"
          git push --tags
      - name: Zip it! zip it good!
        run: |
          cd ${{ github.workspace }}/src/
          mkdir ../build
          zip -r ../build/release.zip .
          pwd
          ls -la ../build/release.zip
      - name: Upload new release zip to Chrome Webstore
        uses: Klemensas/chrome-extension-upload-action
        with:
          refresh-token: ${{ secrets.CHROME_WEBSTORE_REFRESH_TOKEN }}
          client-id: ${{ secrets.CHROME_WEBSTORE_CLIENT_ID }}
          client-secret: ${{ secrets.CHROME_WEBSTORE_CLIENT_SECRET }}
          file-name: './build/release.zip'
          app-id: 'ghfmjkamilolkalibpmokjigalmncfek'
          publish: false
